<!DOCTYPE html>
<html lang="ja">

<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Reading-Record/My page</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="思い出を記録します">
<meta name="keywords" content="映画,本,マンガ,アニメ,記録">
<link rel="stylesheet" href="css/style.css">
<script src="js/openclose.js"></script>
<script src="js/fixmenu_pagetop.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<link rel="stylesheet" type="text/css" href="css/select.css">
<link rel="stylesheet" type="text/css" href="css/counter.css">

</head>

<body>

<div id="container">

<header>
<h1 id="logo"><a href="index.html"><img src="images/logo.png" alt="logo"></a></h1>
</header>

<!--開閉メニュー-->
<nav id="menubar">
  <ul>
    <li><a href="/">Home</a></li>
    <li><a href="/Mypage">My page</a></li>
    <br>
    <li><a href="/Movie">Movie</a></li>
    <li><a href="/Book">Book</a></li>
    <li><a href="/Anime">Anime</a></li>
    <br>
    <li><a href="/sign-out">Sign out</a></li>
  </ul>
</nav>

<div id="contents">

<section>

<h2>My page<br><span>マイページ</span></h2>

<center>
<dd>アイコンをクリックして、あなたの思い出を振り返りましょう。</dd>
<br>
<br>
</center>

<div class="list">
<li><a href="/Movie"><img src="images/icon_movie.png" alt="Movie"></a></li>
</div>

<div class="list">
<li><a href="/Book"><img src="images/icon_book.png" alt="Book"></a></li>
</div>

<div class="list">
<li><a href="/Anime"><img src="images/icon_anime.png" alt="Anime"></a></li>
</div>

</section>

<section>
  <h2>Addition<br><span>思い出の追加</span></h2>

    <div class="form-wrapper">
      <h1 id="form-top">思い出を追加する</h1>
      <form method="POST">
        <div class="form-item">
            <select name="genre" id="sources" class="custom-select sources" placeholder="ジャンル">
              <option value="movie">映画</option>
              <option value="book">書籍</option>
              <option value="anime">アニメ</option>
            </select>
        </div>

        <div class="form-item">
            <label for="title"></label>
            <input id="kensaku" type="search" name="searched" required="required" placeholder="作品のタイトルを入力">
        </div>
        <div class="form-item">
          <select name="title" id="searched" placeholder="検索結果">
          </select>
        </div>
        <div class="form-item">
            <label for="comment"></label>
            <input type="text" name="reputation" required="required" placeholder="ひとことコメント">
        </div>

        <div class="counter">
          <div class="range-slider">
            <span id="rs-bullet" class="rs-label">0</span>
            <input name="point"id="rs-range-line" class="rs-range" required="required" type="range" value="0" min="0" max="100">
          </div>

        <div class="button-panel">
          <input type="submit" class="button" title="add" value="追加する">
        </div>

      </form>
      <div class="form-footer">
      </div>
    </div>
</section>

</div>
<!--/#contents-->

<footer>
<small>Copyright&copy; <a href="/">Reading-Record</a> All Rights Reserved.</small>
<span class="pr"><a href="https://template-party.com/" target="_blank">《Web Design:Template-Party》</a></span>
</footer>

</div>
<!--/#container-->

<p class="nav-fix-pos-pagetop"><a href="#">↑</a></p>

<!--メニュー開閉ボタン-->
<div id="menubar_hdr" class="close"></div>

<!--メニューの開閉処理-->
<script>
open_close("menubar_hdr", "menubar");
</script>

<!--lightbox用jsファイルの読み込み-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.10.0/js/lightbox-plus-jquery.min.js"></script>

<!--セレクト用JS-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="js/select.js"></script>

<!--カウンター用JS-->
<script src="js/counter.js"></script>

<script>
  $(function() {
      //定数
      const IMG_URL = 'https://image.tmdb.org/t/p/w1280';
      const main = document.getElementById("main")

      //apiをfetchで起動
      async function getData(url, genre){
          const res = await fetch(url);
          const data = await res.json()

          if (genre == "book"){
              create_books(data.items)
          }
          else if (genre == "anime"){
              create_animes(data.results)
          }
          else{
              create_movies(data.results)
          }

      }

      //書籍の情報をHTMLに追加
      function create_books(books){
          var select = document.getElementById("searched");
          while (select.lastChild){
              select.removeChild(select.lastChild);
          }

          books.forEach((book) => {
              //オブジェクトから各変数に格納
              const vi = book.volumeInfo;
              const title = vi.title;
              const link = vi.infoLink;
              const image = vi.imageLinks ? vi.imageLinks.smallThumbnail : '';
              const description = vi.description;

              //bookパネルを作成
              const bookEl = document.createElement("option")
              bookEl.text = title;
              bookEl.value = title;

              select.appendChild(bookEl);

              /*
              bookEl.classList.add("data")

              //bookパネルをHTMLに埋め込む
              bookEl.innerHTML = `
                  <a href='${link}', target='_blank'>
                  <img src='${image}' alt="${title}">
                  <div class='info'>
                      <h3>${title}</h3>
                  </div>
                  <div class="description">
                      <h3>概要</h3>
                      ${description}
                  </div>
              `

              main.appendChild(bookEl);*/
          });


      }

      //アニメの情報をHTMLに追加
      function create_animes(animes){

          //TVドラマからジャンルがアニメのものかを判断
          function isAnime(anime){
              var genres = anime.genre_ids
              for(var i = 0; i < genres.length; i++){
                  if (genres[i] === 16){
                      return true
                  }
              }
              return false
          }
          var select = document.getElementById("searched");
          while (select.lastChild){
              select.removeChild(select.lastChild);
          }

          animes.forEach((anime) => {
              // オブジェクトから各変数に格納
              const {
              name,
              poster_path,
              vote_average,
              overview,
              id
              } = anime

              var isanime = isAnime(anime)

              if (!isanime){ return; }


              // Animeパネルを作成
              const animeEl = document.createElement('option')
              animeEl.text = name;
              animeEl.value = name;

              select.appendChild(animeEl);

              /*
              // AnimeパネルをHTMLに埋め込む
              animeEl.innerHTML =  `
              <a href='https://www.themoviedb.org/tv/${id}?language=ja', target='_blank'>
                  <img src="${IMG_URL + poster_path}" alt="${name}">
                  <div class="info">
                      <h3>${name}</h3>
                  </div>
                  <div class="description">
                      <h3>概要</h3>
                      ${overview}
                  </div>
              `
              main.appendChild(animeEl)*/
          });
      }

      //映画の情報をHTMLに追加
      function create_movies(movies){
          var select = document.getElementById("searched");
          while (select.lastChild){
              select.removeChild(select.lastChild);
          }

          movies.forEach((movie) => {
              // オブジェクトから各変数に格納
              const {
              title,
              poster_path,
              vote_average,
              overview,
              id
              } = movie

              // Movieパネルを作成
              const movieEl = document.createElement('option')
              movieEl.text = title;
              movieEl.value = title;

              select.appendChild(movieEl);

              /*
              movieEl.classList.add('data')
              // MoveパネルをHTMLに埋め込む
              movieEl.innerHTML =  `
                  <a href='https://www.themoviedb.org/movie/${id}?language=ja', target='_blank'>
                  <img src="${IMG_URL + poster_path}" alt="${title}">
                  <div class="info">
                      <h3>${title}</h3>
                  </div>
                  <div class="description">
                      <h3>概要</h3>
                      ${overview}
                  </div>
              `
              main.appendChild(movieEl)*/
          });

      }

      //apiと検索ワードを連携
      function searchWord(url, searchText, genre){

          $("#main").empty();

          if (searchText != ""){
              url += searchText;

              getData(url, genre);
              searchText = "";
          }

      }

      /*
      //書籍が検索された時にapiを起動させる
      $("#books").on("input", function(){
          var searchText = $(this).val();
          let books_api = 'https://www.googleapis.com/books/v1/volumes?q="';
          searchWord(books_api, searchText, "books")
      });

      //アニメが検索された時にapiを起動させる
      $("#animes").on("input", function(){
          var searchText = $(this).val();
          const animes_api = 'https://api.themoviedb.org/3/search/tv?api_key=171292ccf09cbfac848a76942f6ef28f&language=ja-JA&query="';
          searchWord(animes_api, searchText, "animes")
      });

      //映画が検索された時にapiを起動させる
      $("#movies").on("input", function(){
          var searchText = $(this).val();
          let movies_api = 'https://api.themoviedb.org/3/search/movie?api_key=171292ccf09cbfac848a76942f6ef28f&language=ja-JA&query="';
          searchWord(movies_api, searchText, "movies")
      });
      */

      //検索された時にapiを起動させる
      $("#kensaku").on("input", function(){
          var genre = $("#sources").val();
          console.log(genre)
          var searchText = $(this).val();

          if (genre === "movie"){
              let movies_api = 'https://api.themoviedb.org/3/search/movie?api_key=171292ccf09cbfac848a76942f6ef28f&language=ja-JA&query="';
              searchWord(movies_api, searchText, genre)

          }else if (genre === "book"){
              let books_api = 'https://www.googleapis.com/books/v1/volumes?q="';
              searchWord(books_api, searchText, genre)

          }else if (genre === "anime"){
              let animes_api = 'https://api.themoviedb.org/3/search/tv?api_key=171292ccf09cbfac848a76942f6ef28f&language=ja-JA&query="';
              searchWord(animes_api, searchText, genre)

          }else{
              alert("ジャンルを選択してください")
          }

      });


      /*
      //エンターが押された時に画面をリロードしないようにする
      const form = document.getElementById("form");

      form.addEventListener("submit", (e) => {
          e.preventDefault()
      });*/

  });

</script>

</body>
</html>
